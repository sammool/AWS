name: Simple CI/CD (Direct Secrets Injection)

on:
  push:
    branches: [ "main" ]     # main ë¸Œëœì¹˜ì— push/merge ë˜ë©´ ìë™ ì‹¤í–‰
  workflow_dispatch:          # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Grant permission to Gradle
        run: chmod +x gradlew

      - name: Build with Gradle (skip tests)
        run: ./gradlew clean build -x test

      - name: Copy jar to EC2 and restart app
        env:
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
          EC2_HOST: ${{ secrets.EC2_HOST }}

          # Spring Bootì—ì„œ ì‚¬ìš©í•  DB / AWS í™˜ê²½ ë³€ìˆ˜
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}

        run: |
          echo "ğŸ”‘ Setting up SSH key..."
          echo "$EC2_SSH_KEY" > private_key.pem
          chmod 600 private_key.pem

          # ë¹Œë“œëœ JAR íŒŒì¼ ì°¾ê¸° (plain.jar ì œì™¸)
          jar_file=$(find build/libs -name '*.jar' ! -name '*plain.jar' | head -n 1)
          if [ ! -f "$jar_file" ]; then
            echo "ğŸš¨ JAR not found. Deploy failed."
            exit 1
          fi

          echo "âœ… Found jar: $jar_file"
          echo "âœ… Uploading to EC2..."
          scp -i private_key.pem -o StrictHostKeyChecking=no "$jar_file" $EC2_USERNAME@$EC2_HOST:/home/$EC2_USERNAME/app/app.jar

          echo "âœ… Restarting application on EC2..."
          ssh -i private_key.pem -o StrictHostKeyChecking=no $EC2_USERNAME@$EC2_HOST << EOF
          mkdir -p /home/$EC2_USERNAME/app
          pkill -f app.jar || true
          sleep 3

          # í™˜ê²½ ë³€ìˆ˜ë¥¼ Java ì‹¤í–‰ ì•ì— ì§ì ‘ ë¶™ì—¬ì„œ ì£¼ì…
          DB_PASSWORD="${DB_PASSWORD}" \
          AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID}" \
          AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY}" \
          AWS_REGION="${AWS_REGION}" \
          nohup /usr/bin/java -jar /home/$EC2_USERNAME/app/app.jar > /home/$EC2_USERNAME/app/app.log 2>&1 &

          echo 'âœ… New app started!'
          EOF
          
          rm -f private_key.pem
